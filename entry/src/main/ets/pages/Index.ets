import storage from '@ohos.data.preferences';
import mediaQuery from '@ohos.mediaquery';
import window from '@ohos.window';
import promptAction from '@ohos.promptAction';
import vibrator from '@ohos.vibrator';

enum Priority {
  LOW = 'Low',
  MEDIUM = 'Medium',
  HIGH = 'High'
}

enum SortOption {
  DATE = 'Date',
  PRIORITY = 'Priority',
  ALPHABETICAL = 'Alphabetical'
}

// ä¸»é¢˜æ¨¡å¼
enum ThemeMode {
  LIGHT = 'Light',
  DARK = 'Dark',
  SYSTEM = 'System'
}

// ä¸»é¢˜é¢œè‰²æ¥å£
interface ThemeColors {
  background: string;
  backgroundSecondary: string;
  textPrimary: string;
  textSecondary: string;
  textDisabled: string;
  primary: string;
  cardBackground: string;
  cardBorder: string;
  priorityHigh: string;
  priorityMedium: string;
  priorityLow: string;
  inputBackground: string;
  switchBackground: string;
  emptyState: string;
}

// ä¸»é¢˜é¢œè‰²é…ç½®
class AppTheme {
  static readonly LIGHT: ThemeColors = {
    // èƒŒæ™¯è‰²
    background: '#F2F2F7',
    backgroundSecondary: '#FFFFFF',
    // æ–‡æœ¬è‰²
    textPrimary: '#000000',
    textSecondary: '#8E8E93',
    textDisabled: '#C7C7CC',
    // å¼ºè°ƒè‰²
    primary: '#007AFF',
    // å¡ç‰‡èƒŒæ™¯
    cardBackground: '#FFFFFF',
    cardBorder: 'rgba(0, 0, 0, 0.1)',
    // ä¼˜å…ˆçº§é¢œè‰²
    priorityHigh: '#FF3B30',
    priorityMedium: '#FF9500',
    priorityLow: '#34C759',
    // è¡¨å•å…ƒç´ 
    inputBackground: '#FFFFFF',
    switchBackground: '#E5E5EA',
    // ç©ºçŠ¶æ€
    emptyState: '#E5E5EA',
  };
  
  static readonly DARK: ThemeColors = {
    // èƒŒæ™¯è‰²
    background: '#1C1C1E',
    backgroundSecondary: '#2C2C2E',
    // æ–‡æœ¬è‰²
    textPrimary: '#FFFFFF',
    textSecondary: '#8E8E93',
    textDisabled: '#48484A',
    // å¼ºè°ƒè‰²
    primary: '#0A84FF',
    // å¡ç‰‡èƒŒæ™¯
    cardBackground: '#2C2C2E',
    cardBorder: 'rgba(255, 255, 255, 0.1)',
    // ä¼˜å…ˆçº§é¢œè‰²
    priorityHigh: '#FF453A',
    priorityMedium: '#FF9F0A',
    priorityLow: '#32D74B',
    // è¡¨å•å…ƒç´ 
    inputBackground: '#2C2C2E',
    switchBackground: '#48484A',
    // ç©ºçŠ¶æ€
    emptyState: '#48484A',
  };
}

// Interface for todo item data from storage
interface TodoItemData {
  id: number;
  text: string;
  isCompleted: boolean;
  createdAt: string;
  priority: Priority;
  dueDate?: string | null;  // æˆªæ­¢æ—¥æœŸå¯èƒ½æ˜¯undefinedæˆ–null
  hasReminder?: boolean;  // æ˜¯å¦æœ‰æé†’
}

// å®šä¹‰å­—ä½“å°ºå¯¸é…ç½®æ¥å£
interface FontSizeConfig {
  title: number,
  subtitle: number,
  normal: number,
  small: number
}

// ç»Ÿè®¡æ•°æ®é¡¹æ¥å£
interface PriorityStatItem {
  priority: Priority;
  count: number;
  color: string;
}

// å¯¹è¯æ¡†æŒ‰é’®æ¥å£
interface DialogButton {
  text: string;
  color: string;
}

// æ—¥æœŸé€‰æ‹©å™¨æ•°æ®æ¥å£
interface DatePickerInfo {
  year: number;
  month: number;
  day: number;
}

// å®šä¹‰å“åº”æ¥å£
class DialogResponse {
  index: number = 0;
}

// æ–‡ä»¶é€‰æ‹©å™¨å‘½åé€‰é¡¹
interface FileNameOptions {
  defaultName: string;
}

// Interfaz para propiedades de la barra del sistema de la ventana
interface WindowSystemBarProperties {
  statusBarColor: string;
  statusBarContentColor: string;
  navigationBarColor: string;
  navigationBarContentColor: string;
}

@Entry
@Component
struct Index {
  @State todoList: TodoItem[] = [];
  @State newTodoText: string = '';
  @State selectedPriority: Priority = Priority.MEDIUM;
  @State sortOption: SortOption = SortOption.DATE;
  @State showCompletedTasks: boolean = true;
  @State isAddingNew: boolean = false;
  @State listAnimated: boolean = false;
  
  // æœç´¢ç›¸å…³çŠ¶æ€
  @State searchQuery: string = '';
  @State isSearching: boolean = false;
  @State selectedFilter: string = 'å…¨éƒ¨';  // å¯é€‰å€¼: 'å…¨éƒ¨', 'ä»Šå¤©', 'é‡è¦'
  
  // ä¸»é¢˜ç›¸å…³çŠ¶æ€
  @State themeMode: ThemeMode = ThemeMode.SYSTEM;
  @State isDarkMode: boolean = false;
  @State colors: ThemeColors = AppTheme.LIGHT;
  private systemDarkModeListener = mediaQuery.matchMediaSync('(prefers-color-scheme: dark)');
  
  // å“åº”å¼å¸ƒå±€ç›¸å…³çŠ¶æ€
  @State isTablet: boolean = false;
  @State isLandscape: boolean = false;
  @State screenWidth: number = 0;
  @State contentMaxWidth: Length = '90%';  // ä½¿ç”¨Lengthç±»å‹ï¼Œå¯ä»¥æ¥å—ç™¾åˆ†æ¯”å­—ç¬¦ä¸²
  @State fontSize: FontSizeConfig = { title: 34, subtitle: 18, normal: 16, small: 14 };
  
  private tabletListener = mediaQuery.matchMediaSync('(min-width: 600vp)');
  private landscapeListener = mediaQuery.matchMediaSync('(orientation: landscape)');
  private preferencesKey: string = 'todoListData';
  private preferencesThemeKey: string = 'themeMode';
  private preferences: storage.Preferences | null = null;
  
  // ç»Ÿè®¡ç›¸å…³çŠ¶æ€
  @State showStatistics: boolean = false;
  
  // æˆªæ­¢æ—¥æœŸç›¸å…³çŠ¶æ€
  @State selectedDueDate: Date | null = null;
  @State hasReminder: boolean = false;
  @State showDatePicker: boolean = false;
  @State tempSelectedDate: Date = new Date();

  // ç¼–è¾‘ä»»åŠ¡ç›¸å…³çŠ¶æ€
  @State editingTask: TodoItem | null = null;
  @State editTaskText: string = '';
  @State editTaskPriority: Priority = Priority.MEDIUM;
  @State editTaskDueDate: Date | null = null;
  @State editTaskHasReminder: boolean = false;
  @State showEditTaskPanel: boolean = false;
  
  // DatePickerå¤„ç†å‡½æ•°
  tempDateCallback: (date: Date) => void = () => {};

  // æ—¥æœŸé€‰æ‹©å¤„ç†
  @State datePickerInfo: DatePickerInfo = {
    year: new Date().getFullYear(),
    month: new Date().getMonth() + 1,
    day: new Date().getDate()
  };

  aboutToAppear() {
    // Initialize preferences and load saved todos
    this.initPreferences();
    
    // è®¾ç½®å±å¹•é€‚é…çš„ç›‘å¬å™¨
    this.tabletListener.on('change', (_) => {
      this.isTablet = this.tabletListener.matches;
      this.updateLayoutParams();
    });
    
    this.landscapeListener.on('change', (_) => {
      this.isLandscape = this.landscapeListener.matches;
      this.updateLayoutParams();
    });
    
    // è®¾ç½®ç³»ç»Ÿä¸»é¢˜ç›‘å¬
    this.systemDarkModeListener.on('change', (_) => {
      if (this.themeMode === ThemeMode.SYSTEM) {
        this.updateTheme(ThemeMode.SYSTEM);
      }
    });
    
    // åˆå§‹åŒ–å“åº”å¼çŠ¶æ€
    this.isTablet = this.tabletListener.matches;
    this.isLandscape = this.landscapeListener.matches;
    this.updateLayoutParams();
    
    // å»¶è¿Ÿè§¦å‘åˆ—è¡¨åŠ¨ç”»
    setTimeout(() => {
      this.listAnimated = true;
    }, 100);
  }
  
  aboutToDisappear() {
    // ç§»é™¤ç›‘å¬å™¨
    this.tabletListener.off('change');
    this.landscapeListener.off('change');
    this.systemDarkModeListener.off('change');
  }
  
  // åˆå§‹åŒ–Preferenceså¹¶åŠ è½½æ•°æ®
  async initPreferences() {
    try {
      this.preferences = await storage.getPreferences(getContext(this), 'TodoApp');
      
      // åŠ è½½ä¸»é¢˜è®¾ç½®
      const savedTheme = await this.preferences.get(this.preferencesThemeKey, ThemeMode.SYSTEM);
      this.updateTheme(savedTheme as ThemeMode);
      
      // åŠ è½½å¾…åŠäº‹é¡¹æ•°æ®
      const todoData = await this.preferences.get(this.preferencesKey, '[]');
      const parsedData = JSON.parse(todoData as string) as TodoItemData[];
      
      // Convert plain objects back to TodoItem instances
      this.todoList = parsedData.map((item: TodoItemData) => {
        const todoItem = new TodoItem(
          item.text, 
          item.priority || Priority.MEDIUM,
          item.dueDate ? new Date(item.dueDate) : null,
          item.hasReminder || false
        );
        todoItem.id = item.id;
        todoItem.isCompleted = item.isCompleted;
        todoItem.createdAt = new Date(item.createdAt);
        return todoItem;
      });
      
      this.sortTodos();
      
      // æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦æé†’çš„ä»»åŠ¡
      this.checkReminders();
    } catch (error) {
      console.error('Failed to load preferences:', error);
      this.todoList = [];
      // é»˜è®¤ä½¿ç”¨ç³»ç»Ÿä¸»é¢˜
      this.updateTheme(ThemeMode.SYSTEM);
    }
  }
  
  // æ›´æ–°ä¸»é¢˜è®¾ç½®
  async updateTheme(mode: ThemeMode) {
    this.themeMode = mode;
    
    // æ ¹æ®ä¸»é¢˜æ¨¡å¼å†³å®šæ˜¯å¦ä½¿ç”¨æš—è‰²æ¨¡å¼
    if (mode === ThemeMode.DARK) {
      this.isDarkMode = true;
      this.colors = AppTheme.DARK;
    } else if (mode === ThemeMode.LIGHT) {
      this.isDarkMode = false;
      this.colors = AppTheme.LIGHT;
    } else {
      // è·Ÿéšç³»ç»Ÿä¸»é¢˜
      const isDarkSystem = this.systemDarkModeListener.matches;
      this.isDarkMode = isDarkSystem;
      this.colors = isDarkSystem ? AppTheme.DARK : AppTheme.LIGHT;
    }
    
    // æ›´æ–°çŠ¶æ€æ é¢œè‰²
    this.updateStatusBarColor();
    
    // ä¿å­˜ä¸»é¢˜è®¾ç½®åˆ°Preferences
    if (this.preferences) {
      await this.preferences.put(this.preferencesThemeKey, mode);
      await this.preferences.flush();
    }
  }
  
  // æ›´æ–°çŠ¶æ€æ é¢œè‰²
  async updateStatusBarColor() {
    try {
      const windowClass = await window.getLastWindow(getContext(this));
      
      // è®¾ç½®çŠ¶æ€æ é¢œè‰²
      let barProperties: WindowSystemBarProperties;
      
      if (this.isDarkMode) {
        windowClass.setWindowBackgroundColor('#1C1C1E');
        barProperties = {
          statusBarColor: '#1C1C1E',
          statusBarContentColor: '#FFFFFF',
          navigationBarColor: '#1C1C1E',
          navigationBarContentColor: '#FFFFFF'
        };
      } else {
        windowClass.setWindowBackgroundColor('#F2F2F7');
        barProperties = {
          statusBarColor: '#F2F2F7',
          statusBarContentColor: '#000000',
          navigationBarColor: '#F2F2F7',
          navigationBarContentColor: '#000000'
        };
      }
      
      windowClass.setWindowSystemBarProperties(barProperties);
    } catch (error) {
      console.error('Failed to update status bar color:', error);
    }
  }
  
  // æ›´æ–°å¸ƒå±€å‚æ•°
  updateLayoutParams() {
    // æ ¹æ®å±å¹•å°ºå¯¸è°ƒæ•´å¸ƒå±€å‚æ•°
    if (this.isTablet) {
      this.fontSize = { 
        title: 40, 
        subtitle: 22, 
        normal: 18, 
        small: 16 
      };
      this.contentMaxWidth = this.isLandscape ? '70%' : '85%';
    } else {
      this.fontSize = { 
        title: 34, 
        subtitle: 18, 
        normal: 16, 
        small: 14 
      };
      this.contentMaxWidth = this.isLandscape ? '85%' : '90%';
    }
  }

  async saveTodos() {
    if (this.preferences) {
      try {
        await this.preferences.put(this.preferencesKey, JSON.stringify(this.todoList));
        await this.preferences.flush();
      } catch (error) {
        console.error('Failed to save todos:', error);
      }
    }
  }

  async addTodo() {
    if (this.newTodoText.trim() !== '') {
      this.todoList.push(new TodoItem(
        this.newTodoText.trim(), 
        this.selectedPriority,
        this.selectedDueDate,
        this.hasReminder
      ));
      this.newTodoText = '';
      this.selectedDueDate = null;
      this.hasReminder = false;
      this.sortTodos();
      await this.saveTodos();
      this.isAddingNew = false;
      
      // å¦‚æœæœ‰æé†’ï¼Œåˆ›å»ºæé†’é€šçŸ¥
      // æ³¨æ„ï¼šä¸ºç®€åŒ–ç¤ºä¾‹ï¼Œè¿™é‡Œä¸åˆ›å»ºå®é™…çš„ç³»ç»Ÿæé†’ï¼Œä»…æ˜¾ç¤ºæç¤º
      if (this.hasReminder && this.selectedDueDate) {
        this.showToast('æé†’å·²è®¾ç½®');
      }
    }
  }

  async toggleTodoComplete(index: number) {
    this.todoList[index].isCompleted = !this.todoList[index].isCompleted;
    await this.saveTodos();
  }

  async deleteTodo(index: number) {
    this.todoList.splice(index, 1);
    await this.saveTodos();
  }
  
  sortTodos() {
    switch (this.sortOption) {
      case SortOption.DATE:
        this.todoList.sort((a, b) => b.createdAt.getTime() - a.createdAt.getTime());
        break;
      case SortOption.PRIORITY:
        this.todoList.sort((a, b) => {
          const valueA = a.priority === Priority.HIGH ? 0 : a.priority === Priority.MEDIUM ? 1 : 2;
          const valueB = b.priority === Priority.HIGH ? 0 : b.priority === Priority.MEDIUM ? 1 : 2;
          return valueA - valueB;
        });
        break;
      case SortOption.ALPHABETICAL:
        this.todoList.sort((a, b) => a.text.localeCompare(b.text));
        break;
    }
  }

  getFilteredTodos(): TodoItem[] {
    // åº”ç”¨æœç´¢å’Œè¿‡æ»¤æ¡ä»¶
    let filteredList = this.todoList.filter(item => {
      // æŒ‰å®ŒæˆçŠ¶æ€è¿‡æ»¤
      if (!this.showCompletedTasks && item.isCompleted) {
        return false;
      }
      
      // æŒ‰æœç´¢å…³é”®è¯è¿‡æ»¤
      if (this.searchQuery.trim() !== '' && 
          !item.text.toLowerCase().includes(this.searchQuery.toLowerCase())) {
        return false;
      }
      
      // æŒ‰ç±»åˆ«è¿‡æ»¤
      if (this.selectedFilter === 'ä»Šå¤©') {
        const now = new Date();
        const itemDate = new Date(item.createdAt);
        if (itemDate.getDate() !== now.getDate() || 
            itemDate.getMonth() !== now.getMonth() || 
            itemDate.getFullYear() !== now.getFullYear()) {
          return false;
        }
      } else if (this.selectedFilter === 'é‡è¦') {
        if (item.priority !== Priority.HIGH) {
          return false;
        }
      }
      
      return true;
    });
    
    return filteredList;
  }
  
  // åˆ‡æ¢é€‰å®šçš„è¿‡æ»¤å™¨
  setFilter(filter: string) {
    this.selectedFilter = filter;
  }
  
  // æœç´¢ä»»åŠ¡
  searchTodos(query: string) {
    this.searchQuery = query;
  }
  
  // æ¸…é™¤æœç´¢å’Œè¿‡æ»¤
  clearSearch() {
    this.searchQuery = '';
    this.isSearching = false;
  }

  // è·å–ä»»åŠ¡å®Œæˆç™¾åˆ†æ¯”
  getCompletionPercentage(): number {
    if (this.todoList.length === 0) return 0;
    const completedCount = this.todoList.filter(item => item.isCompleted).length;
    return Math.round((completedCount / this.todoList.length) * 100);
  }
  
  // è·å–å„ä¼˜å…ˆçº§ä»»åŠ¡çš„ç»Ÿè®¡
  getPriorityStats(): PriorityStatItem[] {
    const highStat: PriorityStatItem = { priority: Priority.HIGH, count: 0, color: this.colors.priorityHigh };
    const mediumStat: PriorityStatItem = { priority: Priority.MEDIUM, count: 0, color: this.colors.priorityMedium };
    const lowStat: PriorityStatItem = { priority: Priority.LOW, count: 0, color: this.colors.priorityLow };
    
    const stats: PriorityStatItem[] = [highStat, mediumStat, lowStat];
    
    // è®¡ç®—æ¯ä¸ªä¼˜å…ˆçº§çš„ä»»åŠ¡æ•°é‡
    this.todoList.forEach(item => {
      switch (item.priority) {
        case Priority.HIGH:
          highStat.count++;
          break;
        case Priority.MEDIUM:
          mediumStat.count++;
          break;
        case Priority.LOW:
          lowStat.count++;
          break;
      }
    });
    
    return stats;
  }
  
  // æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦æé†’çš„ä»»åŠ¡
  checkReminders() {
    const now = new Date();
    const overdueItems = this.todoList.filter(item => 
      !item.isCompleted && 
      item.hasReminder && 
      item.dueDate && 
      item.dueDate.getTime() < now.getTime()
    );
    
    // å¯¹äºè¿‡æœŸçš„ä»»åŠ¡ï¼Œå‘é€æé†’
    if (overdueItems.length > 0) {
      this.showToast(`æœ‰ ${overdueItems.length} ä¸ªä»»åŠ¡å·²è¿‡æœŸ`);
    }
  }
  
  // æ˜¾ç¤ºæ—¥æœŸé€‰æ‹©å™¨
  showDatePickerDialog() {
    this.tempSelectedDate = this.selectedDueDate || new Date();
    this.showDatePicker = true;
  }
  
  // ç¡®è®¤é€‰æ‹©çš„æ—¥æœŸ
  confirmDateSelection() {
    this.selectedDueDate = new Date(this.tempSelectedDate);
    this.showDatePicker = false;
  }
  
  // å–æ¶ˆæ—¥æœŸé€‰æ‹©
  cancelDateSelection() {
    this.showDatePicker = false;
  }

  // è®¾ç½®ä¸´æ—¶æ—¥æœŸå›è°ƒå‡½æ•°
  setTempDateCallback(callback: (date: Date) => void) {
    this.tempDateCallback = callback;
  }
  
  // å¤„ç†æ—¥æœŸé€‰æ‹©å™¨çš„å€¼å˜åŒ–
  handleDatePickerChange(value: DatePickerInfo) {
    if (value && typeof value === 'object' && value.year !== undefined && value.month !== undefined && value.day !== undefined) {
      this.datePickerInfo = value;
      const date = new Date(value.year, value.month - 1, value.day);
      this.tempSelectedDate = date;
      this.tempDateCallback(date);
    }
  }
  
  // æ ¼å¼åŒ–æ—¥æœŸ
  formatDate(date: Date | null): string {
    if (!date) return '';
    
    const now = new Date();
    const tomorrow = new Date(now);
    tomorrow.setDate(now.getDate() + 1);
    
    if (date.getDate() === now.getDate() && 
        date.getMonth() === now.getMonth() && 
        date.getFullYear() === now.getFullYear()) {
      return 'ä»Šå¤©';
    } else if (date.getDate() === tomorrow.getDate() && 
               date.getMonth() === tomorrow.getMonth() && 
               date.getFullYear() === tomorrow.getFullYear()) {
      return 'æ˜å¤©';
    } else {
      return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
    }
  }
  
  // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
  showToast(message: string) {
    promptAction.showToast({
      message: message,
      duration: 2000,
      bottom: '50%'
    });
  }
  
  // è®¾ç½®æˆªæ­¢æ—¥æœŸ
  setDueDate(date: Date | null) {
    this.selectedDueDate = date;
    
    // å¦‚æœæ¸…é™¤æˆªæ­¢æ—¥æœŸï¼Œä¹Ÿæ¸…é™¤æé†’
    if (!date) {
      this.hasReminder = false;
    }
  }

  // å¼€å§‹ç¼–è¾‘ä»»åŠ¡
  startEditTask(item: TodoItem) {
    this.editingTask = item;
    this.editTaskText = item.text;
    this.editTaskPriority = item.priority;
    this.editTaskDueDate = item.dueDate;
    this.editTaskHasReminder = item.hasReminder;
    this.showEditTaskPanel = true;
  }
  
  // ä¿å­˜ç¼–è¾‘åçš„ä»»åŠ¡
  async saveEditTask() {
    if (this.editingTask && this.editTaskText.trim() !== '') {
      const index = this.todoList.findIndex(item => item.id === this.editingTask?.id);
      if (index !== -1) {
        this.todoList[index].text = this.editTaskText.trim();
        this.todoList[index].priority = this.editTaskPriority;
        this.todoList[index].dueDate = this.editTaskDueDate;
        this.todoList[index].hasReminder = this.editTaskHasReminder;
        
        this.sortTodos();
        await this.saveTodos();
        this.cancelEditTask();
        
        this.showToast('ä»»åŠ¡å·²æ›´æ–°');
      }
    }
  }
  
  // å–æ¶ˆç¼–è¾‘ä»»åŠ¡
  cancelEditTask() {
    this.editingTask = null;
    this.editTaskText = '';
    this.editTaskDueDate = null;
    this.editTaskHasReminder = false;
    this.showEditTaskPanel = false;
  }
  
  // æŒ¯åŠ¨åé¦ˆ
  vibrateShort() {
    try {
      // VibraciÃ³n corta de 10ms
      vibrator.vibrate(10);
    } catch (error) {
      console.error('Failed to vibrate:', error);
    }
  }

  // è·å–ä¼˜å…ˆçº§é¢œè‰²
  getPriorityColor(priority: Priority): string {
    switch (priority) {
      case Priority.HIGH:
        return this.colors.priorityHigh;
      case Priority.MEDIUM:
        return this.colors.priorityMedium;
      case Priority.LOW:
        return this.colors.priorityLow;
      default:
        return this.colors.textSecondary;
    }
  }
  
  // æ¸…ç©ºæ‰€æœ‰ä»»åŠ¡
  async clearAllTasks() {
    try {
      const dialogButtons: Array<DialogButton> = [
        {
          text: 'å–æ¶ˆ',
          color: '#8E8E93'
        },
        {
          text: 'ç¡®å®šåˆ é™¤',
          color: '#FF3B30'
        }
      ];
      
      const dialogOptions: promptAction.ShowDialogOptions = {
        title: 'ç¡®è®¤æ¸…ç©º',
        message: 'ç¡®å®šè¦åˆ é™¤æ‰€æœ‰ä»»åŠ¡å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚',
        buttons: dialogButtons
      };
      
      // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
      const result: DialogResponse = await promptAction.showDialog(dialogOptions) as DialogResponse;
      if (result && result.index === 1) {
        // ç”¨æˆ·ç¡®è®¤æ¸…ç©º
        this.todoList = [];
        await this.saveTodos();
        this.showToast('å·²æ¸…ç©ºæ‰€æœ‰ä»»åŠ¡');
      }
    } catch (error) {
      console.error('å¯¹è¯æ¡†æ˜¾ç¤ºå¤±è´¥:', error);
      this.showToast('å¯¹è¯æ¡†æ˜¾ç¤ºå¤±è´¥: ' + String(error));
    }
  }

  build() {
    Row() {
      // å¤„ç†æ¨ªå±å¸ƒå±€ - å¯ä»¥æ·»åŠ ä¾§è¾¹æ 
      if (this.isLandscape && this.isTablet) {
        Column() {
          Row() {
            Text('Todoåˆ†ç±»')
              .fontSize(this.fontSize.subtitle)
              .fontWeight(FontWeight.Bold)
              .fontColor(this.colors.textPrimary)
              .padding(16)
            
            Blank()
            
            // ä¸»é¢˜åˆ‡æ¢æŒ‰é’®
            Button() {
              Column() {
                Text(this.isDarkMode ? 'â˜€ï¸' : 'ğŸŒ™')
                  .fontSize(20)
                  .fontColor(this.isDarkMode ? '#FFFFFF' : '#000000')
              }
            }
            .width(40)
            .height(40)
            .backgroundColor('transparent')
            .margin({ right: 16 })
            .onClick(() => {
              this.updateTheme(this.isDarkMode ? ThemeMode.LIGHT : ThemeMode.DARK);
            })
          }
          .width('100%')
          
          Divider()
            .width('80%')
            .color(this.colors.textDisabled)
          
          Column() {
            Button() {
              Column() {
                Text('å…¨éƒ¨ä»»åŠ¡')
                  .width('100%')
                  .height(50)
                  .fontSize(this.fontSize.normal)
                  .fontColor(this.selectedFilter === 'å…¨éƒ¨' ? '#FFFFFF' : this.colors.primary)
              }
            }
            .width('90%')
            .height(50)
            .margin({ top: 16 })
            .backgroundColor(this.selectedFilter === 'å…¨éƒ¨' ? this.colors.primary : this.colors.switchBackground)
            .borderRadius(8)
            .onClick(() => {
              this.setFilter('å…¨éƒ¨');
            })
            
            Button() {
              Column() {
                Text('ä»Šæ—¥ä»»åŠ¡')
                  .width('100%')
                  .height(50)
                  .fontSize(this.fontSize.normal)
                  .fontColor(this.selectedFilter === 'ä»Šå¤©' ? '#FFFFFF' : this.colors.primary)
              }
            }
            .width('90%')
            .height(50)
            .margin({ top: 16 })
            .backgroundColor(this.selectedFilter === 'ä»Šå¤©' ? this.colors.primary : this.colors.switchBackground)
            .borderRadius(8)
            .onClick(() => {
              this.setFilter('ä»Šå¤©');
            })
              
            Button() {
              Column() {
                Text('é‡è¦ä»»åŠ¡')
                  .width('100%')
                  .height(50)
                  .fontSize(this.fontSize.normal)
                  .fontColor(this.selectedFilter === 'é‡è¦' ? '#FFFFFF' : this.colors.priorityHigh)
              }
            }
            .width('90%')
            .height(50)
            .margin({ top: 16 })
            .backgroundColor(this.selectedFilter === 'é‡è¦' ? this.colors.primary : this.colors.switchBackground)
            .borderRadius(8)
            .onClick(() => {
              this.setFilter('é‡è¦');
            })
          }
          .width('100%')
          .alignItems(HorizontalAlign.Center)
          .layoutWeight(1)
        }
        .width('30%')
        .height('100%')
        .backgroundColor(this.colors.background)
        .padding({ top: 48 })
      }
      
      // ä¸»å†…å®¹åŒºåŸŸ
      Column() {
        // Header section
        Row() {
          Column() {
            Text('Todo')
              .fontSize(this.fontSize.title)
              .fontWeight(FontWeight.Bold)
              .fontColor(this.colors.textPrimary)

            Text(`${this.todoList.length} ä»»åŠ¡ | ${this.todoList.filter(item => item.isCompleted).length} å·²å®Œæˆ`)
              .fontSize(this.fontSize.small)
              .fontColor(this.colors.textSecondary)
              .margin({ top: 4 })
          }
          .alignItems(HorizontalAlign.Start)

          Blank()
          
          // ç»Ÿè®¡æŒ‰é’®
          Button() {
            Column() {
              Text('ğŸ“Š')
                .fontSize(20)
                .fontColor(this.isDarkMode ? '#FFFFFF' : '#000000')
            }
          }
          .width(40)
          .height(40)
          .backgroundColor('transparent')
          .margin({ right: 8 })
          .onClick(() => {
            this.showStatistics = !this.showStatistics;
          })
          
          // ä¸»é¢˜åˆ‡æ¢æŒ‰é’®
          if (!(this.isLandscape && this.isTablet)) {
            Button() {
              Column() {
                Text(this.isDarkMode ? 'â˜€ï¸' : 'ğŸŒ™')
                  .fontSize(20)
                  .fontColor(this.isDarkMode ? '#FFFFFF' : '#000000')
              }
            }
            .width(40)
            .height(40)
            .backgroundColor('transparent')
            .margin({ right: 16 })
            .onClick(() => {
              this.updateTheme(this.isDarkMode ? ThemeMode.LIGHT : ThemeMode.DARK);
            })
          }

          Row() {
            Toggle({ type: ToggleType.Switch, isOn: this.showCompletedTasks })
              .onChange((isOn: boolean) => {
                this.showCompletedTasks = isOn;
              })
              .width(50)
              .height(28)
              .selectedColor(this.colors.primary)
            
            Text('æ˜¾ç¤ºå·²å®Œæˆ')
              .fontSize(this.fontSize.small)
              .fontColor(this.colors.textSecondary)
              .margin({ left: 8 })
          }
        }
        .width(this.contentMaxWidth)
        .padding({ top: this.isTablet ? 64 : 48, bottom: 24 })
        
        // ç»Ÿè®¡é¢æ¿ (ä»…åœ¨showStatisticsä¸ºtrueæ—¶æ˜¾ç¤º)
        if (this.showStatistics) {
          Column() {
            // æ ‡é¢˜
            Text('ä»»åŠ¡ç»Ÿè®¡')
              .fontSize(this.fontSize.subtitle)
              .fontWeight(FontWeight.Bold)
              .fontColor(this.colors.textPrimary)
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 16 })
            
            // ç®€åŒ–çš„ç»Ÿè®¡ä¿¡æ¯
            Row() {
              // å®Œæˆç‡
              Column() {
                Text(`${this.getCompletionPercentage()}%`)
                  .fontSize(this.fontSize.subtitle)
                  .fontWeight(FontWeight.Bold)
                  .fontColor(this.colors.textPrimary)
                  
                Text('å·²å®Œæˆ')
                  .fontSize(this.fontSize.small)
                  .fontColor(this.colors.textSecondary)
              }
              .alignItems(HorizontalAlign.Center)
              .layoutWeight(1)
              .height('100%')
              .backgroundColor(this.colors.cardBackground)
              .borderRadius(12)
              .padding(16)
            }
            .width('100%')
            .height(this.isTablet ? 100 : 80)
          }
          .width(this.contentMaxWidth)
          .padding(10)
          .backgroundColor(this.isDarkMode ? 'rgba(0, 0, 0, 0.1)' : 'rgba(0, 0, 0, 0.02)')
          .borderRadius(16)
          .animation({
            duration: 300,
            curve: Curve.EaseOut,
            iterations: 1,
            playMode: PlayMode.Normal
          })
          .margin({ bottom: 20 })
        }
        
        // æœç´¢æ 
        Row() {
          Stack({ alignContent: Alignment.Center }) {
            TextInput({ placeholder: 'æœç´¢ä»»åŠ¡...', text: this.searchQuery })
              .width('100%')
              .height(this.isTablet ? 50 : 44)
              .borderRadius(22)
              .backgroundColor(this.colors.inputBackground)
              .placeholderColor(this.colors.textSecondary)
              .padding({ left: 44, right: 16 })
              .fontSize(this.fontSize.normal)
              .fontColor(this.colors.textPrimary)
              .onChange((value: string) => {
                this.searchTodos(value);
              })
              .onSubmit(() => {
                // å½“ç”¨æˆ·æŒ‰ä¸‹æœç´¢æˆ–å›è½¦é”®æ—¶è§¦å‘
                this.isSearching = this.searchQuery.trim() !== '';
              })
              
            // æœç´¢å›¾æ ‡
            Text('ğŸ”')
              .fontSize(20)
              .fontColor(this.colors.textSecondary)
              .margin({ left: 16 })
              .position({ x: 0, y: '50%' })
              .translate({ y: -12 })
              
            // æ¸…é™¤æŒ‰é’® (ä»…åœ¨æœ‰æœç´¢æ–‡æœ¬æ—¶æ˜¾ç¤º)
            if (this.searchQuery.length > 0) {
              Button() {
                Column() {
                  Circle()
                    .width(16)
                    .height(16)
                    .fill(this.colors.textSecondary)
                  
                  Text('Ã—')
                    .fontSize(12)
                    .fontColor(this.isDarkMode ? '#000000' : '#FFFFFF')
                    .position({ x: '50%', y: '50%' })
                    .translate({ x: -6, y: -9 })
                }
              }
              .width(20)
              .height(20)
              .backgroundColor('transparent')
              .position({ x: '95%', y: '50%' })
              .translate({ x: -20, y: -10 })
              .onClick(() => {
                this.clearSearch();
              })
            }
          }
          .width('100%')
        }
        .width(this.contentMaxWidth)
        .margin({ bottom: 16 })
        
        // è¿‡æ»¤æ ‡ç­¾ (ä»…åœ¨éå¹³æ¿æ¨ªå±æ¨¡å¼ä¸‹æ˜¾ç¤º)
        if (!(this.isLandscape && this.isTablet)) {
          Row() {
            ForEach(['å…¨éƒ¨', 'ä»Šå¤©', 'é‡è¦'], (filter: string) => {
              Text(filter)
                .fontSize(this.fontSize.small)
                .fontColor(this.selectedFilter === filter ? this.colors.primary : this.colors.textSecondary)
                .fontWeight(this.selectedFilter === filter ? FontWeight.Medium : FontWeight.Normal)
                .backgroundColor(this.selectedFilter === filter ? (this.isDarkMode ? '#2C2C2E' : '#E5E5EA') : 'transparent')
                .borderRadius(12)
                .padding({ left: 12, right: 12, top: 6, bottom: 6 })
                .margin({ right: 8 })
                .onClick(() => {
                  this.setFilter(filter);
                })
            })
          }
          .width(this.contentMaxWidth)
          .margin({ bottom: 16 })
        }

        // Sorting section
        Row() {
          Text('æ’åº:')
            .fontSize(this.fontSize.small)
            .fontColor(this.colors.textSecondary)
            .margin({ right: 10 })

          ForEach([SortOption.DATE, SortOption.PRIORITY, SortOption.ALPHABETICAL], (option: SortOption) => {
            Text(option)
              .fontSize(this.fontSize.small)
              .fontColor(this.sortOption === option ? this.colors.primary : this.colors.textSecondary)
              .fontWeight(this.sortOption === option ? FontWeight.Medium : FontWeight.Normal)
              .margin({ right: 16 })
              .onClick(() => {
                this.sortOption = option;
                this.sortTodos();
              })
          })

          Blank()

          Button() {
            Column() {
              Text('+')
                .fontSize(this.fontSize.subtitle)
                .fontWeight(FontWeight.Medium)
                .fontColor('#FFFFFF')
            }
          }
          .width(this.isTablet ? 42 : 36)
          .height(this.isTablet ? 42 : 36)
          .backgroundColor(this.colors.primary)
          .borderRadius(this.isTablet ? 21 : 18)
          .onClick(() => {
            this.isAddingNew = true;
          })
        }
        .width(this.contentMaxWidth)
        .margin({ bottom: 20 })

        // Add new task panel (only visible when adding)
        if (this.isAddingNew) {
          Column() {
            TextInput({ placeholder: 'æ·»åŠ æ–°çš„ä»»åŠ¡...', text: this.newTodoText })
              .onChange((value: string) => {
                this.newTodoText = value;
              })
              .width('100%')
              .height(this.isTablet ? 60 : 50)
              .borderRadius(8)
              .backgroundColor(this.colors.inputBackground)
              .placeholderColor(this.colors.textSecondary)
              .padding(16)
              .margin({ bottom: 16 })
              .fontColor(this.colors.textPrimary)
              .fontSize(this.fontSize.normal)
            
            // æˆªæ­¢æ—¥æœŸé€‰æ‹©å™¨
            Row() {
              Text('æˆªæ­¢æ—¥æœŸ:')
                .fontSize(this.fontSize.small)
                .fontColor(this.colors.textSecondary)
                .margin({ right: 12 })
              
              if (this.selectedDueDate) {
                // æ˜¾ç¤ºå·²é€‰æ‹©çš„æ—¥æœŸ
                Button() {
                  Column() {
                    Row() {
                      Text(this.formatDate(this.selectedDueDate))
                        .fontSize(this.fontSize.small)
                        .fontColor(this.colors.primary)
                      
                      Text(' Ã—')
                        .fontSize(this.fontSize.small)
                        .fontColor(this.colors.primary)
                        .margin({ left: 8 })
                    }
                  }
                }
                .backgroundColor(this.isDarkMode ? 'rgba(10, 132, 255, 0.2)' : 'rgba(0, 122, 255, 0.1)')
                .borderRadius(8)
                .padding({ left: 12, right: 12, top: 6, bottom: 6 })
                .onClick(() => {
                  this.setDueDate(null);
                })
              } else {
                // æ·»åŠ æˆªæ­¢æ—¥æœŸæŒ‰é’®
                Button() {
                  Column() {
                    Text('æ·»åŠ ')
                      .fontSize(this.fontSize.small)
                      .fontColor(this.colors.primary)
                  }
                }
                .backgroundColor('transparent')
                .padding({ left: 12, right: 12, top: 6, bottom: 6 })
                .onClick(() => {
                  this.tempSelectedDate = new Date();
                  this.showDatePicker = true;
                  
                  // è®¾ç½®æ—¥æœŸé€‰æ‹©å®Œæˆåçš„å›è°ƒ
                  this.setTempDateCallback((date: Date) => {
                    this.editTaskDueDate = date;
                  });
                })
              }
              
              Blank()
              
              // æé†’å¼€å…³
              if (this.selectedDueDate) {
                Row() {
                  Text('æé†’:')
                    .fontSize(this.fontSize.small)
                    .fontColor(this.colors.textSecondary)
                    .margin({ right: 8 })
                  
                  Toggle({ type: ToggleType.Checkbox, isOn: this.hasReminder })
                    .onChange((isOn: boolean) => {
                      this.hasReminder = isOn;
                    })
                    .width(20)
                    .height(20)
                    .selectedColor(this.colors.primary)
                }
              }
            }
            .width('100%')
            .margin({ bottom: 16 })
            
            // æ—¥æœŸé€‰æ‹©å™¨å¼¹çª—
            if (this.showDatePicker) {
              Column() {
                // æ—¥æœŸé€‰æ‹©å™¨
                DatePicker({
                  start: new Date('2020-01-01'),
                  end: new Date('2030-12-31'),
                  selected: this.tempSelectedDate,
                })
                  .onChange((value: DatePickerInfo) => {
                    this.handleDatePickerChange(value);
                  })
                  .backgroundColor(this.colors.cardBackground)
                  .width('100%')
                
                // ç¡®è®¤å’Œå–æ¶ˆæŒ‰é’®
                Row() {
                  Button() {
                    Column() {
                      Text('å–æ¶ˆ')
                        .fontSize(this.fontSize.normal)
                        .fontColor(this.colors.textSecondary)
                    }
                  }
                  .backgroundColor('transparent')
                  .onClick(() => {
                    this.cancelDateSelection();
                  })
                  
                  Blank()
                  
                  Button() {
                    Column() {
                      Text('ç¡®è®¤')
                        .fontSize(this.fontSize.normal)
                        .fontColor(this.colors.primary)
                    }
                  }
                  .backgroundColor('transparent')
                  .onClick(() => {
                    this.confirmDateSelection();
                  })
                }
                .width('100%')
                .padding({ top: 12, bottom: 12 })
              }
              .width('100%')
              .backgroundColor(this.isDarkMode ? '#3C3C3E' : '#FFFFFF')
              .borderRadius(12)
              .padding(16)
              .margin({ bottom: 16 })
              .animation({
                duration: 200,
                curve: Curve.EaseOut,
                iterations: 1,
                playMode: PlayMode.Normal
              })
            }
            
            Row() {
              ForEach([Priority.LOW, Priority.MEDIUM, Priority.HIGH], (priority: Priority) => {
                Column() {
                  Circle()
                    .fill(this.getPriorityColor(priority))
                    .width(this.isTablet ? 20 : 16)
                    .height(this.isTablet ? 20 : 16)
                    .opacity(this.selectedPriority === priority ? 1 : 0.5)
                    
                  Text(priority)
                    .fontSize(this.fontSize.small)
                    .fontColor(this.selectedPriority === priority ? this.getPriorityColor(priority) : this.colors.textSecondary)
                    .fontWeight(this.selectedPriority === priority ? FontWeight.Medium : FontWeight.Normal)
                    .margin({ top: 8 })
                }
                .padding(12)
                .borderRadius(8)
                .backgroundColor(this.selectedPriority === priority ? (this.isDarkMode ? '#2C2C2E' : '#F2F2F7') : 'transparent')
                .margin({ right: 16 })
                .onClick(() => {
                  this.selectedPriority = priority;
                })
              })

              Blank()

              Row() {
                Button() {
                  Column() {
                    Text('å–æ¶ˆ')
                      .fontSize(this.fontSize.normal)
                      .fontWeight(FontWeight.Medium)
                      .fontColor(this.colors.textSecondary)
                  }
                }
                .backgroundColor('transparent')
                .margin({ right: 16 })
                .onClick(() => {
                  this.cancelEditTask();
                })
                
                Button() {
                  Column() {
                    Text('æ·»åŠ ')
                      .fontSize(this.fontSize.normal)
                      .fontWeight(FontWeight.Medium)
                      .fontColor('#FFFFFF')
                  }
                }
                .backgroundColor(this.colors.primary)
                .borderRadius(8)
                .padding({ left: 16, right: 16, top: this.isTablet ? 8 : 4, bottom: this.isTablet ? 8 : 4 })
                .enabled(this.newTodoText.trim() !== '')
                .opacity(this.newTodoText.trim() !== '' ? 1 : 0.5)
                .onClick(() => {
                  this.addTodo();
                })
              }
            }
            .width('100%')
            .justifyContent(FlexAlign.SpaceBetween)
          }
          .width(this.contentMaxWidth)
          .padding(16)
          .backgroundColor(this.isDarkMode ? '#2C2C2E' : '#F2F2F7')
          .borderRadius(12)
          .margin({ bottom: 20 })
          .animation({
            duration: 300,
            curve: Curve.EaseOut,
            iterations: 1,
            playMode: PlayMode.Normal
          })
        }

        // æœç´¢ç»“æœç»Ÿè®¡ (ä»…åœ¨æœç´¢æ—¶æ˜¾ç¤º)
        if (this.searchQuery.trim() !== '') {
          Text(`æ‰¾åˆ° ${this.getFilteredTodos().length} ä¸ªç»“æœ`)
            .fontSize(this.fontSize.small)
            .fontColor(this.colors.textSecondary)
            .width(this.contentMaxWidth)
            .margin({ bottom: 12 })
        }

        // Todo list
        List({ space: this.isTablet ? 12 : 8 }) {
          ForEach(this.getFilteredTodos(), (item: TodoItem, index: number) => {
            ListItem() {
              TodoItemComponent({
                item: item,
                onDelete: () => {
                  this.deleteTodo(index);
                },
                onToggleComplete: () => {
                  this.toggleTodoComplete(index);
                },
                onEdit: (item: TodoItem) => {
                  this.startEditTask(item);
                },
                animationDelay: index * 50,
                isTablet: this.isTablet,
                fontSize: this.fontSize,
                colors: this.colors,
                isDarkMode: this.isDarkMode
              })
            }
            .opacity(this.listAnimated ? 1 : 0)
            .animation({
              duration: 300,
              curve: Curve.EaseOut,
              delay: index * 50,
              iterations: 1,
              playMode: PlayMode.Normal,
              onFinish: () => {
                // åŠ¨ç”»å®Œæˆåçš„å›è°ƒï¼Œå¦‚æœéœ€è¦çš„è¯
              }
            })
          })
        }
        .width(this.contentMaxWidth)
        .layoutWeight(1)

        // ç©ºçŠ¶æ€ä¿¡æ¯
        if (this.getFilteredTodos().length === 0) {
          Column() {
            Text('â˜‘')
              .fontSize(this.isTablet ? 72 : 56)
              .fontColor(this.colors.emptyState)
              .margin({ bottom: 16 })
              
            if (this.searchQuery.trim() !== '') {
              // æ— æœç´¢ç»“æœçŠ¶æ€
              Text('æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ä»»åŠ¡')
                .fontSize(this.fontSize.subtitle)
                .fontColor(this.colors.textSecondary)
                .fontWeight(FontWeight.Medium)
                
              Text('å°è¯•ä½¿ç”¨ä¸åŒçš„æœç´¢è¯æˆ–è¿‡æ»¤å™¨')
                .fontSize(this.fontSize.small)
                .fontColor(this.colors.textSecondary)
                .margin({ top: 8 })
            } else {
              // æ— ä»»åŠ¡çŠ¶æ€
              Text('æ²¡æœ‰ä»»åŠ¡')
                .fontSize(this.fontSize.subtitle)
                .fontColor(this.colors.textSecondary)
                .fontWeight(FontWeight.Medium)
                
              Text(this.isAddingNew ? 'ç‚¹å‡»"æ·»åŠ "æŒ‰é’®åˆ›å»ºæ–°çš„ä»»åŠ¡' : 'ç‚¹å‡»"+"æŒ‰é’®åˆ›å»ºæ–°çš„ä»»åŠ¡')
                .fontSize(this.fontSize.small)
                .fontColor(this.colors.textSecondary)
                .margin({ top: 8 })
            }
          }
          .width('100%')
          .layoutWeight(1)
          .justifyContent(FlexAlign.Center)
          .opacity(this.listAnimated ? 1 : 0)
          .animation({
            duration: 500,
            curve: Curve.EaseOut,
            delay: 100,
            iterations: 1,
            playMode: PlayMode.Normal
          })
        }

        // Edit task panel
        if (this.showEditTaskPanel) {
          Column() {
            Text('ç¼–è¾‘ä»»åŠ¡')
              .fontSize(this.fontSize.subtitle)
              .fontWeight(FontWeight.Bold)
              .fontColor(this.colors.textPrimary)
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 16 })
            
            TextInput({ placeholder: 'ä»»åŠ¡å†…å®¹...', text: this.editTaskText })
              .onChange((value: string) => {
                this.editTaskText = value;
              })
              .width('100%')
              .height(this.isTablet ? 60 : 50)
              .borderRadius(8)
              .backgroundColor(this.colors.inputBackground)
              .placeholderColor(this.colors.textSecondary)
              .padding(16)
              .margin({ bottom: 16 })
              .fontColor(this.colors.textPrimary)
              .fontSize(this.fontSize.normal)
            
            // æˆªæ­¢æ—¥æœŸé€‰æ‹©å™¨
            Row() {
              Text('æˆªæ­¢æ—¥æœŸ:')
                .fontSize(this.fontSize.small)
                .fontColor(this.colors.textSecondary)
                .margin({ right: 12 })
              
              if (this.editTaskDueDate) {
                // æ˜¾ç¤ºå·²é€‰æ‹©çš„æ—¥æœŸ
                Button() {
                  Column() {
                    Row() {
                      Text(this.formatDate(this.editTaskDueDate))
                        .fontSize(this.fontSize.small)
                        .fontColor(this.colors.primary)
                      
                      Text(' Ã—')
                        .fontSize(this.fontSize.small)
                        .fontColor(this.colors.primary)
                        .margin({ left: 8 })
                    }
                  }
                }
                .backgroundColor(this.isDarkMode ? 'rgba(10, 132, 255, 0.2)' : 'rgba(0, 122, 255, 0.1)')
                .borderRadius(8)
                .padding({ left: 12, right: 12, top: 6, bottom: 6 })
                .onClick(() => {
                  this.editTaskDueDate = null;
                  this.editTaskHasReminder = false;
                })
              } else {
                // æ·»åŠ æˆªæ­¢æ—¥æœŸæŒ‰é’®
                Button() {
                  Column() {
                    Text('æ·»åŠ ')
                      .fontSize(this.fontSize.small)
                      .fontColor(this.colors.primary)
                  }
                }
                .backgroundColor('transparent')
                .padding({ left: 12, right: 12, top: 6, bottom: 6 })
                .onClick(() => {
                  this.tempSelectedDate = new Date();
                  this.showDatePicker = true;
                  
                  // è®¾ç½®æ—¥æœŸé€‰æ‹©å®Œæˆåçš„å›è°ƒ
                  this.setTempDateCallback((date: Date) => {
                    this.editTaskDueDate = date;
                  });
                })
              }
              
              Blank()
              
              // æé†’å¼€å…³
              if (this.editTaskDueDate) {
                Row() {
                  Text('æé†’:')
                    .fontSize(this.fontSize.small)
                    .fontColor(this.colors.textSecondary)
                    .margin({ right: 8 })
                  
                  Toggle({ type: ToggleType.Checkbox, isOn: this.editTaskHasReminder })
                    .onChange((isOn: boolean) => {
                      this.editTaskHasReminder = isOn;
                    })
                    .width(20)
                    .height(20)
                    .selectedColor(this.colors.primary)
                }
              }
            }
            .width('100%')
            .margin({ bottom: 16 })
            
            // ä¼˜å…ˆçº§é€‰æ‹©
            Row() {
              Text('ä¼˜å…ˆçº§:')
                .fontSize(this.fontSize.small)
                .fontColor(this.colors.textSecondary)
                .margin({ right: 12 })
              
              ForEach([Priority.LOW, Priority.MEDIUM, Priority.HIGH], (priority: Priority) => {
                Column() {
                  Circle()
                    .fill(this.getPriorityColor(priority))
                    .width(this.isTablet ? 20 : 16)
                    .height(this.isTablet ? 20 : 16)
                    .opacity(this.editTaskPriority === priority ? 1 : 0.5)
                    
                  Text(priority)
                    .fontSize(this.fontSize.small)
                    .fontColor(this.editTaskPriority === priority ? this.getPriorityColor(priority) : this.colors.textSecondary)
                    .fontWeight(this.editTaskPriority === priority ? FontWeight.Medium : FontWeight.Normal)
                    .margin({ top: 8 })
                }
                .padding(12)
                .borderRadius(8)
                .backgroundColor(this.editTaskPriority === priority ? (this.isDarkMode ? '#2C2C2E' : '#F2F2F7') : 'transparent')
                .margin({ right: 16 })
                .onClick(() => {
                  this.editTaskPriority = priority;
                })
              })
            }
            .width('100%')
            .margin({ bottom: 16 })
            
            // æŒ‰é’®è¡Œ
            Row() {
              Button() {
                Column() {
                  Text('å–æ¶ˆ')
                    .fontSize(this.fontSize.normal)
                    .fontWeight(FontWeight.Medium)
                    .fontColor(this.colors.textSecondary)
                }
              }
              .backgroundColor('transparent')
              .margin({ right: 16 })
              .onClick(() => {
                this.cancelEditTask();
              })
              
              Blank()
              
              Button() {
                Column() {
                  Text('ä¿å­˜')
                    .fontSize(this.fontSize.normal)
                    .fontWeight(FontWeight.Medium)
                    .fontColor('#FFFFFF')
                }
              }
              .backgroundColor(this.colors.primary)
              .borderRadius(8)
              .padding({ left: 16, right: 16, top: this.isTablet ? 8 : 4, bottom: this.isTablet ? 8 : 4 })
              .enabled(this.editTaskText.trim() !== '')
              .opacity(this.editTaskText.trim() !== '' ? 1 : 0.5)
              .onClick(() => {
                this.saveEditTask();
              })
            }
            .width('100%')
          }
          .width(this.contentMaxWidth)
          .padding(16)
          .backgroundColor(this.isDarkMode ? '#2C2C2E' : '#F2F2F7')
          .borderRadius(12)
          .margin({ bottom: 20 })
          .animation({
            duration: 300,
            curve: Curve.EaseOut,
            iterations: 1,
            playMode: PlayMode.Normal
          })
        }
      }
      .width(this.isLandscape && this.isTablet ? '70%' : '100%')
      .height('100%')
      .backgroundColor(this.colors.background)
    }
    .width('100%')
    .height('100%')
  }
}

// Todo item component
@Component
struct TodoItemComponent {
  item: TodoItem = new TodoItem('');
  onDelete: () => void = () => {};
  onToggleComplete: () => void = () => {};
  onEdit: (item: TodoItem) => void = () => {};
  animationDelay: number = 0;
  isTablet: boolean = false;
  fontSize: FontSizeConfig = { title: 34, subtitle: 18, normal: 16, small: 14 };
  colors: ThemeColors = AppTheme.LIGHT;
  isDarkMode: boolean = false;
  @State isSwipedLeft: boolean = false;
  @State isSwipedRight: boolean = false;
  @State isAnimated: boolean = false;
  @State isPressed: boolean = false;

  aboutToAppear() {
    // ç»„ä»¶å‡ºç°æ—¶è§¦å‘åŠ¨ç”»
    setTimeout(() => {
      this.isAnimated = true;
    }, this.animationDelay);
  }

  build() {
    Stack({ alignContent: Alignment.Center }) {
      // Delete button (revealed when swiped)
      Row() {
        Blank()
        Button() {
          Column() {
            Text('åˆ é™¤')
              .fontSize(this.fontSize.small)
              .fontColor('#FFFFFF')
          }
        }
        .height('100%')
        .backgroundColor(this.colors.priorityHigh)
        .borderRadius(12)
        .width(this.isTablet ? 100 : 80)
        .onClick(() => {
          this.vibrateShort();
          this.onDelete();
        })
      }
      .width('100%')
      .height('100%')
      .visibility(this.isSwipedLeft ? Visibility.Visible : Visibility.Hidden)
      
      // Complete button (revealed when swiped right)
      Row() {
        Button() {
          Column() {
            Text(this.item.isCompleted ? 'æœªå®Œæˆ' : 'å®Œæˆ')
              .fontSize(this.fontSize.small)
              .fontColor('#FFFFFF')
          }
        }
        .height('100%')
        .backgroundColor(this.colors.priorityLow)
        .borderRadius(12)
        .width(this.isTablet ? 100 : 80)
        .onClick(() => {
          this.vibrateShort();
          this.onToggleComplete();
        })
        
        Blank()
      }
      .width('100%')
      .height('100%')
      .visibility(this.isSwipedRight ? Visibility.Visible : Visibility.Hidden)
      
      // æ‹–åŠ¨æç¤º
      if (!this.isSwipedLeft && !this.isSwipedRight) {
        Row() {
          Text(this.isPressed ? 'å·¦æ»‘åˆ é™¤ Â· å³æ»‘å®Œæˆ Â· é•¿æŒ‰ç¼–è¾‘' : '')
            .fontSize(12)
            .fontColor(this.colors.textSecondary)
            .opacity(0.7)
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .backgroundColor(this.colors.background)
        .position({ x: 0, y: 0 })
        .zIndex(1)
        .opacity(this.isPressed ? 0.9 : 0)
        .animation({
          duration: 200,
          curve: Curve.EaseOut
        })
      }
      
      // Todo item card
      Column() {
        Row() {
          // Custom checkbox
          Stack({ alignContent: Alignment.Center }) {
            Circle()
              .width(this.isTablet ? 28 : 24)
              .height(this.isTablet ? 28 : 24)
              .fill(this.item.isCompleted ? this.colors.primary : this.colors.cardBackground)
              .stroke(this.item.isCompleted ? this.colors.primary : this.colors.textDisabled)
              .strokeWidth(2)
              
            if (this.item.isCompleted) {
              Text('âœ“')
                .fontSize(this.isTablet ? 18 : 16)
                .fontColor('#FFFFFF')
            }
          }
          .width(this.isTablet ? 28 : 24)
          .height(this.isTablet ? 28 : 24)
          .margin({ right: 16 })
          .onClick(() => {
            this.onToggleComplete();
          })

          Column() {
            Text(this.item.text)
              .fontSize(this.isTablet ? 18 : 17)
              .fontColor(this.item.isCompleted ? this.colors.textSecondary : this.colors.textPrimary)
              .decoration({ type: this.item.isCompleted ? TextDecorationType.LineThrough : TextDecorationType.None })
              .width('100%')
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .maxLines(2)

            Row() {
              // Priority indicator
              Circle()
                .width(8)
                .height(8)
                .fill(this.getPriorityColor(this.item.priority))
                .margin({ right: 6 })
                
              Text(this.item.priority)
                .fontSize(this.fontSize.small)
                .fontColor(this.colors.textSecondary)
                .margin({ right: 12 })
                
              // æˆªæ­¢æ—¥æœŸ
              if (this.item.dueDate) {
                Row() {
                  // æ—¥å†å›¾æ ‡
                  Text('ğŸ“…')
                    .fontSize(12)
                    .margin({ right: 4 })
                  
                  // æ—¥æœŸæ–‡æœ¬
                  Text(this.formatDate(this.item.dueDate))
                    .fontSize(this.fontSize.small)
                    .fontColor(this.item.isOverdue() ? this.colors.priorityHigh : 
                              (this.item.isComingSoon() ? this.colors.priorityMedium : this.colors.textSecondary))
                    .fontWeight(this.item.isOverdue() || this.item.isComingSoon() ? FontWeight.Medium : FontWeight.Normal)
                }
                .margin({ right: 12 })
              }
              
              // æé†’å›¾æ ‡
              if (this.item.hasReminder) {
                Text('ğŸ””')
                  .fontSize(12)
                  .margin({ right: 8 })
              }
              
              // Date
              Text(this.formatDate(this.item.createdAt))
                .fontSize(this.fontSize.small)
                .fontColor(this.colors.textSecondary)
            }
            .margin({ top: 6 })
          }
          .layoutWeight(1)
        }
        .width('100%')
      }
      .padding(this.isTablet ? 20 : 16)
      .backgroundColor(this.colors.cardBackground)
      .borderRadius(12)
      .shadow({ radius: 1, color: this.colors.cardBorder, offsetX: 0, offsetY: 1 })
      .translate({ 
        x: this.isSwipedLeft ? 
           (this.isTablet ? -100 : -80) : 
           (this.isSwipedRight ? (this.isTablet ? 100 : 80) : 0) 
      })
      .opacity(this.isPressed ? 0.8 : 1)
      .scale({ x: this.isPressed ? 0.98 : 1, y: this.isPressed ? 0.98 : 1 })
      .animation({ 
        duration: 200, 
        curve: Curve.EaseOut 
      })
      .gesture(
        GestureGroup(GestureMode.Parallel,
          SwipeGesture({ direction: SwipeDirection.Horizontal })
            .onAction((event: GestureEvent) => {
              if (event.offsetX < -20) {
                this.isSwipedLeft = true;
                this.isSwipedRight = false;
                this.vibrateShort();
              } else if (event.offsetX > 20) {
                this.isSwipedRight = true;
                this.isSwipedLeft = false;
                this.vibrateShort();
              }
            }),
          TapGesture()
            .onAction(() => {
              if (this.isSwipedLeft || this.isSwipedRight) {
                this.isSwipedLeft = false;
                this.isSwipedRight = false;
              }
            }),
          LongPressGesture()
            .onAction(() => {
              this.vibrateShort();
              if (this.onEdit) {
                this.onEdit(this.item);
              }
            })
            .onActionCancel(() => {
              this.isPressed = true;
            })
            .onActionEnd(() => {
              this.isPressed = false;
            })
        )
      )
    }
    .height(this.item.text.length > 30 ? 'auto' : (this.isTablet ? 88 : 76))
    .clip(true)
    .opacity(this.isAnimated ? 1 : 0)
    .animation({
      duration: 300,
      curve: Curve.EaseOut,
      delay: this.animationDelay,
      iterations: 1,
      playMode: PlayMode.Normal
    })
  }

  private formatDate(date: Date | null): string {
    if (!date) return '';
    
    const now = new Date();
    const tomorrow = new Date(now);
    tomorrow.setDate(now.getDate() + 1);
    
    if (date.getDate() === now.getDate() && 
        date.getMonth() === now.getMonth() && 
        date.getFullYear() === now.getFullYear()) {
      return 'ä»Šå¤©';
    } else if (date.getDate() === tomorrow.getDate() && 
               date.getMonth() === tomorrow.getMonth() && 
               date.getFullYear() === tomorrow.getFullYear()) {
      return 'æ˜å¤©';
    } else {
      return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
    }
  }

  private getPriorityColor(priority: Priority): string {
    switch (priority) {
      case Priority.HIGH:
        return this.colors.priorityHigh;
      case Priority.MEDIUM:
        return this.colors.priorityMedium;
      case Priority.LOW:
        return this.colors.priorityLow;
      default:
        return this.colors.textSecondary;
    }
  }

  // åˆ¤æ–­ä»»åŠ¡æ˜¯å¦å³å°†åˆ°æœŸ
  private isComingSoon(): boolean {
    if (!this.item.dueDate) return false;
    
    return this.item.isComingSoon();
  }
  
  // åˆ¤æ–­ä»»åŠ¡æ˜¯å¦å·²è¿‡æœŸ
  private isOverdue(): boolean {
    if (!this.item.dueDate) return false;
    
    return this.item.isOverdue();
  }

  // çŸ­æŒ¯åŠ¨
  private vibrateShort() {
    try {
      // VibraciÃ³n corta de 10ms
      vibrator.vibrate(10);
    } catch (error) {
      console.error('Failed to vibrate:', error);
    }
  }
}

// Todo item class
class TodoItem {
  id: number;
  text: string;
  isCompleted: boolean;
  createdAt: Date;
  priority: Priority;
  dueDate: Date | null;  // æˆªæ­¢æ—¥æœŸ
  hasReminder: boolean;  // æ˜¯å¦æœ‰æé†’

  constructor(text: string, priority: Priority = Priority.MEDIUM, dueDate: Date | null = null, hasReminder: boolean = false) {
    this.id = Date.now();
    this.text = text;
    this.isCompleted = false;
    this.createdAt = new Date();
    this.priority = priority;
    this.dueDate = dueDate;
    this.hasReminder = hasReminder;
  }
  
  // æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å³å°†åˆ°æœŸï¼ˆ24å°æ—¶å†…ï¼‰
  isComingSoon(): boolean {
    if (!this.dueDate) return false;
    
    const now = new Date();
    const diff = this.dueDate.getTime() - now.getTime();
    const oneDay = 24 * 60 * 60 * 1000;
    
    return diff > 0 && diff < oneDay;
  }
  
  // æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å·²è¿‡æœŸ
  isOverdue(): boolean {
    if (!this.dueDate) return false;
    
    const now = new Date();
    return this.dueDate.getTime() < now.getTime();
  }
}
